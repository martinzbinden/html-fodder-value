<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AGFF Futterbewertung</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- jsPDF CDN for PDF Generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- Firebase Libraries -->
    <script type="module">
        // Firebase SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- GLOBALE VARIABLEN ---
        let futterWerte = {};
        let aktuellesStadiumLabel = "Nicht bestimmt";
        let db, auth;
        const PB_NEL = 3.14; // Produktionsbedarf NEL pro kg ECM (Seite 12)
        const PB_PROTEIN = 50; // Produktionsbedarf APDE/APDN pro kg ECM (Seite 12)

        // --- DATENLADEN & FIREBASE INIT ---
        document.addEventListener('DOMContentLoaded', () => {
            showLoading(true);
            try {
                // 1. Firebase initialisieren (als separate async Funktion)
                initializeFirebase();

                // 3. Futterwerte direkt laden (um file:// Protokoll-Fehler zu vermeiden)
                futterWerte = {
                  "erster": {
                    "greenfeed": {
                      "G": {
                        "1": { "nel": 7.5, "apde": 154, "apdn": 121, "tsv": 18 },
                        "2": { "nel": 6.9, "apde": 132, "apdn": 115, "tsv": 18 },
                        "3": { "nel": 6.5, "apde": 102, "apdn": 99, "tsv": 16 },
                        "4": { "nel": 5.9, "apde": 81, "apdn": 92, "tsv": 15 },
                        "5": { "nel": 5.1, "apde": 68, "apdn": 82, "tsv": 13 },
                        "6": { "nel": 4.6, "apde": 56, "apdn": 73, "tsv": 12 },
                        "7": { "nel": 4.1, "apde": 48, "apdn": 67, "tsv": 11 }
                      },
                      "GR": {
                        "1": { "nel": 7.3, "apde": 115, "apdn": 129, "tsv": 18 },
                        "2": { "nel": 7.4, "apde": 122, "apdn": 114, "tsv": 18 },
                        "3": { "nel": 7, "apde": 95, "apdn": 104, "tsv": 17 },
                        "4": { "nel": 6.6, "apde": 73, "apdn": 94, "tsv": 16 },
                        "5": { "nel": 5.8, "apde": 60, "apdn": 84, "tsv": 15 },
                        "6": { "nel": 5.2, "apde": 47, "apdn": 75, "tsv": 13 },
                        "7": { "nel": 4.8, "apde": 42, "apdn": 68, "tsv": 12 }
                      },
                      "A": {
                        "1": { "nel": 7, "apde": 151, "apdn": 120, "tsv": 18 },
                        "2": { "nel": 6.8, "apde": 133, "apdn": 115, "tsv": 18 },
                        "3": { "nel": 6.7, "apde": 106, "apdn": 105, "tsv": 17 },
                        "4": { "nel": 5.9, "apde": 95, "apdn": 88, "tsv": 15 },
                        "5": { "nel": 5.4, "apde": 87, "apdn": 77, "tsv": 14 },
                        "6": { "nel": 4.9, "apde": 76, "apdn": 66, "tsv": 13 },
                        "7": { "nel": 4.5, "apde": 68, "apdn": 59, "tsv": 12 }
                      },
                      "AR": {
                        "1": { "nel": 7.5, "apde": 117, "apdn": 135, "tsv": 18 },
                        "2": { "nel": 7, "apde": 126, "apdn": 114, "tsv": 18 },
                        "3": { "nel": 6.7, "apde": 102, "apdn": 107, "tsv": 17 },
                        "4": { "nel": 6.4, "apde": 82, "apdn": 98, "tsv": 17 },
                        "5": { "nel": 5.8, "apde": 88, "apdn": 71, "tsv": 15 },
                        "6": { "nel": 5.2, "apde": 75, "apdn": 59, "tsv": 14 },
                        "7": { "nel": 4.8, "apde": 67, "apdn": 52, "tsv": 13 }
                      },
                      "L": {
                        "1": { "nel": 7.5, "apde": 123, "apdn": 167, "tsv": 18 },
                        "2": { "nel": 7, "apde": 154, "apdn": 120, "tsv": 18 },
                        "3": { "nel": 7.3, "apde": 116, "apdn": 139, "tsv": 18 },
                        "4": { "nel": 6.8, "apde": 122, "apdn": 109, "tsv": 17 },
                        "5": { "nel": 6.2, "apde": 109, "apdn": 102, "tsv": 16 },
                        "6": { "nel": 5.6, "apde": 95, "apdn": 91, "tsv": 15 },
                        "7": { "nel": 5.1, "apde": 84, "apdn": 82, "tsv": 14 }
                      },
                      "KF": {
                        "1": { "nel": 7.3, "apde": 114, "apdn": 129, "tsv": 18 },
                        "2": { "nel": 7.2, "apde": 123, "apdn": 112, "tsv": 18 },
                        "3": { "nel": 6.9, "apde": 104, "apdn": 100, "tsv": 17 },
                        "4": { "nel": 6.6, "apde": 97, "apdn": 84, "tsv": 16 },
                        "5": { "nel": 6.4, "apde": 93, "apdn": 78, "tsv": 16 },
                        "6": { "nel": 5.9, "apde": 84, "apdn": 68, "tsv": 15 },
                        "7": { "nel": 5.5, "apde": 76, "apdn": 60, "tsv": 14 }
                      },
                      "KG": {
                        "1": { "nel": 6.7, "apde": 108, "apdn": 123, "tsv": 17 },
                        "2": { "nel": 6.5, "apde": 114, "apdn": 104, "tsv": 16 },
                        "3": { "nel": 6.2, "apde": 102, "apdn": 100, "tsv": 15 },
                        "4": { "nel": 5.6, "apde": 93, "apdn": 93, "tsv": 14 },
                        "5": { "nel": 5.1, "apde": 87, "apdn": 87, "tsv": 13 },
                        "6": { "nel": 4.6, "apde": 80, "apdn": 80, "tsv": 12 },
                        "7": { "nel": 4.1, "apde": 74, "apdn": 74, "tsv": 11 }
                      }
                    },
                    "silage": {
                      "G": {
                        "1": { "nel": 7.3, "apde": 91, "apdn": 151, "tsv": 17 },
                        "2": { "nel": 7.1, "apde": 88, "apdn": 130, "tsv": 17 },
                        "3": { "nel": 6.3, "apde": 82, "apdn": 99, "tsv": 15 },
                        "4": { "nel": 5.5, "apde": 81, "apdn": 74, "tsv": 14 },
                        "5": { "nel": 4.8, "apde": 67, "apdn": 68, "tsv": 12 },
                        "6": { "nel": 4.3, "apde": 56, "apdn": 59, "tsv": 11 },
                        "7": { "nel": 3.9, "apde": 48, "apdn": 53, "tsv": 10 }
                      },
                      "GR": {
                        "1": { "nel": 7.1, "apde": 89, "apdn": 128, "tsv": 17 },
                        "2": { "nel": 7.2, "apde": 89, "apdn": 121, "tsv": 17 },
                        "3": { "nel": 6.8, "apde": 85, "apdn": 94, "tsv": 16 },
                        "4": { "nel": 6.3, "apde": 78, "apdn": 73, "tsv": 15 },
                        "5": { "nel": 5.5, "apde": 61, "apdn": 70, "tsv": 14 },
                        "6": { "nel": 4.9, "apde": 51, "apdn": 60, "tsv": 13 },
                        "7": { "nel": 4.5, "apde": 46, "apdn": 53, "tsv": 11 }
                      },
                      "A": {
                        "1": { "nel": 7.2, "apde": 90, "apdn": 149, "tsv": 17 },
                        "2": { "nel": 7, "apde": 88, "apdn": 131, "tsv": 17 },
                        "3": { "nel": 6.4, "apde": 83, "apdn": 105, "tsv": 16 },
                        "4": { "nel": 5.7, "apde": 77, "apdn": 87, "tsv": 14 },
                        "5": { "nel": 5.1, "apde": 70, "apdn": 76, "tsv": 13 },
                        "6": { "nel": 4.6, "apde": 62, "apdn": 66, "tsv": 12 },
                        "7": { "nel": 4.2, "apde": 55, "apdn": 59, "tsv": 11 }
                      },
                      "AR": {
                        "1": { "nel": 7.3, "apde": 90, "apdn": 133, "tsv": 17 },
                        "2": { "nel": 7.2, "apde": 89, "apdn": 124, "tsv": 17 },
                        "3": { "nel": 6.9, "apde": 86, "apdn": 101, "tsv": 17 },
                        "4": { "nel": 6.4, "apde": 80, "apdn": 82, "tsv": 16 },
                        "5": { "nel": 5.6, "apde": 73, "apdn": 71, "tsv": 14 },
                        "6": { "nel": 5, "apde": 63, "apdn": 61, "tsv": 13 },
                        "7": { "nel": 4.6, "apde": 57, "apdn": 55, "tsv": 12 }
                      },
                      "L": {
                        "1": { "nel": 7.4, "apde": 91, "apdn": 164, "tsv": 18 },
                        "2": { "nel": 7.2, "apde": 90, "apdn": 152, "tsv": 17 },
                        "3": { "nel": 7.1, "apde": 88, "apdn": 137, "tsv": 17 },
                        "4": { "nel": 6.6, "apde": 84, "apdn": 120, "tsv": 16 },
                        "5": { "nel": 6, "apde": 80, "apdn": 108, "tsv": 15 },
                        "6": { "nel": 5.4, "apde": 73, "apdn": 95, "tsv": 14 },
                        "7": { "nel": 4.9, "apde": 67, "apdn": 85, "tsv": 13 }
                      },
                      "KF": {
                        "1": { "nel": 7.1, "apde": 88, "apdn": 128, "tsv": 17 },
                        "2": { "nel": 7, "apde": 87, "apdn": 121, "tsv": 17 },
                        "3": { "nel": 6.7, "apde": 84, "apdn": 100, "tsv": 16 },
                        "4": { "nel": 6.4, "apde": 84, "apdn": 80, "tsv": 15 },
                        "5": { "nel": 6.1, "apde": 77, "apdn": 78, "tsv": 15 },
                        "6": { "nel": 5.6, "apde": 70, "apdn": 68, "tsv": 14 },
                        "7": { "nel": 5.2, "apde": 64, "apdn": 61, "tsv": 13 }
                      },
                      "KG": {
                        "1": { "nel": 6.5, "apde": 83, "apdn": 122, "tsv": 16 },
                        "2": { "nel": 6.3, "apde": 81, "apdn": 113, "tsv": 15 },
                        "3": { "nel": 6, "apde": 78, "apdn": 101, "tsv": 14 },
                        "4": { "nel": 5.4, "apde": 74, "apdn": 93, "tsv": 13 },
                        "5": { "nel": 4.7, "apde": 68, "apdn": 86, "tsv": 12 },
                        "6": { "nel": 4.3, "apde": 61, "apdn": 79, "tsv": 11 },
                        "7": { "nel": 3.9, "apde": 55, "apdn": 73, "tsv": 10 }
                      }
                    },
                    "hay": {
                      "G": {
                        "1": { "nel": 6.6, "apde": 108, "apdn": 131, "tsv": 18 },
                        "2": { "nel": 6.5, "apde": 103, "apdn": 113, "tsv": 18 },
                        "3": { "nel": 5.9, "apde": 86, "apdn": 92, "tsv": 16 },
                        "4": { "nel": 5.3, "apde": 70, "apdn": 83, "tsv": 15 },
                        "5": { "nel": 4.6, "apde": 59, "apdn": 74, "tsv": 13 },
                        "6": { "nel": 4.1, "apde": 47, "apdn": 65, "tsv": 12 },
                        "7": { "nel": 3.7, "apde": 40, "apdn": 60, "tsv": 11 }
                      },
                      "GR": {
                        "1": { "nel": 6.5, "apde": 111, "apdn": 103, "tsv": 18 },
                        "2": { "nel": 6.6, "apde": 102, "apdn": 105, "tsv": 18 },
                        "3": { "nel": 6.4, "apde": 82, "apdn": 94, "tsv": 18 },
                        "4": { "nel": 6, "apde": 63, "apdn": 85, "tsv": 16 },
                        "5": { "nel": 5.3, "apde": 53, "apdn": 77, "tsv": 15 },
                        "6": { "nel": 4.7, "apde": 42, "apdn": 67, "tsv": 13 },
                        "7": { "nel": 4.3, "apde": 38, "apdn": 61, "tsv": 12 }
                      },
                      "A": {
                        "1": { "nel": 6.5, "apde": 107, "apdn": 129, "tsv": 18 },
                        "2": { "nel": 6.4, "apde": 102, "apdn": 114, "tsv": 18 },
                        "3": { "nel": 6, "apde": 94, "apdn": 90, "tsv": 17 },
                        "4": { "nel": 5.5, "apde": 75, "apdn": 86, "tsv": 15 },
                        "5": { "nel": 4.9, "apde": 66, "apdn": 78, "tsv": 14 },
                        "6": { "nel": 4.4, "apde": 55, "apdn": 71, "tsv": 13 },
                        "7": { "nel": 4.1, "apde": 48, "apdn": 66, "tsv": 12 }
                      },
                      "AR": {
                        "1": { "nel": 6.6, "apde": 104, "apdn": 115, "tsv": 18 },
                        "2": { "nel": 6.6, "apde": 107, "apdn": 102, "tsv": 18 },
                        "3": { "nel": 6.4, "apde": 88, "apdn": 96, "tsv": 17 },
                        "4": { "nel": 6.1, "apde": 71, "apdn": 88, "tsv": 17 },
                        "5": { "nel": 5.3, "apde": 62, "apdn": 80, "tsv": 15 },
                        "6": { "nel": 4.8, "apde": 51, "apdn": 71, "tsv": 14 },
                        "7": { "nel": 4.4, "apde": 45, "apdn": 65, "tsv": 13 }
                      },
                      "L": {
                        "1": { "nel": 6.7, "apde": 142, "apdn": 110, "tsv": 18 },
                        "2": { "nel": 6.6, "apde": 132, "apdn": 108, "tsv": 18 },
                        "3": { "nel": 6.5, "apde": 104, "apdn": 120, "tsv": 18 },
                        "4": { "nel": 6.1, "apde": 98, "apdn": 105, "tsv": 17 },
                        "5": { "nel": 5.5, "apde": 94, "apdn": 92, "tsv": 16 },
                        "6": { "nel": 5, "apde": 85, "apdn": 82, "tsv": 15 },
                        "7": { "nel": 4.5, "apde": 76, "apdn": 74, "tsv": 14 }
                      },
                      "KF": {
                        "1": { "nel": 6.4, "apde": 102, "apdn": 110, "tsv": 17 },
                        "2": { "nel": 6.4, "apde": 100, "apdn": 105, "tsv": 17 },
                        "3": { "nel": 6.2, "apde": 86, "apdn": 93, "tsv": 17 },
                        "4": { "nel": 6, "apde": 87, "apdn": 72, "tsv": 16 },
                        "5": { "nel": 5.8, "apde": 78, "apdn": 84, "tsv": 16 },
                        "6": { "nel": 5.5, "apde": 67, "apdn": 80, "tsv": 15 },
                        "7": { "nel": 5.4, "apde": 74, "apdn": 46, "tsv": 15 }
                      },
                      "KG": {
                        "1": { "nel": 5.9, "apde": 105, "apdn": 96, "tsv": 16 },
                        "2": { "nel": 5.8, "apde": 97, "apdn": 93, "tsv": 16 },
                        "3": { "nel": 5.5, "apde": 89, "apdn": 87, "tsv": 15 },
                        "4": { "nel": 5, "apde": 80, "apdn": 83, "tsv": 14 },
                        "5": { "nel": 4.4, "apde": 75, "apdn": 77, "tsv": 13 },
                        "6": { "nel": 4.3, "apde": 70, "apdn": 75, "tsv": 13 },
                        "7": { "nel": 4.3, "apde": 74, "apdn": 68, "tsv": 13 }
                      }
                    }
                  },
                  "folge": {
                    "greenfeed": {
                      "G": {
                        "1": { "nel": 6.2, "apde": 107, "apdn": 129, "tsv": 16 },
                        "2": { "nel": 6, "apde": 102, "apdn": 117, "tsv": 15 },
                        "3": { "nel": 5.6, "apde": 96, "apdn": 100, "tsv": 14 },
                        "4": { "nel": 5.4, "apde": 91, "apdn": 88, "tsv": 14 }
                      },
                      "GR": {
                        "1": { "nel": 6.5, "apde": 107, "apdn": 123, "tsv": 16 },
                        "2": { "nel": 6.4, "apde": 114, "apdn": 105, "tsv": 16 },
                        "3": { "nel": 5.9, "apde": 101, "apdn": 99, "tsv": 15 },
                        "4": { "nel": 5.5, "apde": 92, "apdn": 89, "tsv": 14 }
                      },
                      "A": {
                        "1": { "nel": 6.3, "apde": 133, "apdn": 108, "tsv": 16 },
                        "2": { "nel": 6.1, "apde": 121, "apdn": 104, "tsv": 15 },
                        "3": { "nel": 5.7, "apde": 98, "apdn": 107, "tsv": 14 },
                        "4": { "nel": 5.5, "apde": 93, "apdn": 96, "tsv": 14 }
                      },
                      "AR": {
                        "1": { "nel": 6.5, "apde": 108, "apdn": 128, "tsv": 16 },
                        "2": { "nel": 6.4, "apde": 119, "apdn": 105, "tsv": 16 },
                        "3": { "nel": 6, "apde": 106, "apdn": 100, "tsv": 15 },
                        "4": { "nel": 5.7, "apde": 95, "apdn": 96, "tsv": 14 }
                      },
                      "L": {
                        "1": { "nel": 6.7, "apde": 114, "apdn": 152, "tsv": 17 },
                        "2": { "nel": 6.5, "apde": 110, "apdn": 140, "tsv": 16 },
                        "3": { "nel": 6, "apde": 130, "apdn": 106, "tsv": 15 },
                        "4": { "nel": 5.9, "apde": 102, "apdn": 121, "tsv": 15 }
                      },
                      "KF": {
                        "1": { "nel": 6.4, "apde": 123, "apdn": 105, "tsv": 16 },
                        "2": { "nel": 6.3, "apde": 117, "apdn": 104, "tsv": 16 },
                        "3": { "nel": 6.2, "apde": 107, "apdn": 101, "tsv": 15 },
                        "4": { "nel": 6.1, "apde": 101, "apdn": 99, "tsv": 15 }
                      },
                      "KG": {
                        "1": { "nel": 6.4, "apde": 125, "apdn": 106, "tsv": 16 },
                        "2": { "nel": 6, "apde": 114, "apdn": 101, "tsv": 15 },
                        "3": { "nel": 5.6, "apde": 98, "apdn": 113, "tsv": 14 },
                        "4": { "nel": 5.3, "apde": 107, "apdn": 94, "tsv": 13 }
                      }
                    },
                    "silage": {
                      "G": {
                        "1": { "nel": 5.9, "apde": 80, "apdn": 127, "tsv": 15 },
                        "2": { "nel": 5.8, "apde": 79, "apdn": 115, "tsv": 14 },
                        "3": { "nel": 5.4, "apde": 75, "apdn": 100, "tsv": 13 },
                        "4": { "nel": 5.2, "apde": 72, "apdn": 88, "tsv": 13 }
                      },
                      "GR": {
                        "1": { "nel": 6.1, "apde": 82, "apdn": 122, "tsv": 15 },
                        "2": { "nel": 6.1, "apde": 82, "apdn": 113, "tsv": 15 },
                        "3": { "nel": 5.7, "apde": 78, "apdn": 100, "tsv": 14 },
                        "4": { "nel": 5.3, "apde": 74, "apdn": 89, "tsv": 13 }
                      },
                      "A": {
                        "1": { "nel": 6.1, "apde": 81, "apdn": 131, "tsv": 15 },
                        "2": { "nel": 5.9, "apde": 79, "apdn": 119, "tsv": 14 },
                        "3": { "nel": 5.5, "apde": 76, "apdn": 105, "tsv": 13 },
                        "4": { "nel": 5.3, "apde": 73, "apdn": 95, "tsv": 13 }
                      },
                      "AR": {
                        "1": { "nel": 6.3, "apde": 82, "apdn": 127, "tsv": 15 },
                        "2": { "nel": 6.2, "apde": 81, "apdn": 118, "tsv": 15 },
                        "3": { "nel": 5.8, "apde": 78, "apdn": 106, "tsv": 14 },
                        "4": { "nel": 5.5, "apde": 76, "apdn": 95, "tsv": 14 }
                      },
                      "L": {
                        "1": { "nel": 6.3, "apde": 84, "apdn": 150, "tsv": 16 },
                        "2": { "nel": 6.1, "apde": 82, "apdn": 138, "tsv": 15 },
                        "3": { "nel": 5.9, "apde": 79, "apdn": 129, "tsv": 14 },
                        "4": { "nel": 5.6, "apde": 78, "apdn": 119, "tsv": 14 }
                      },
                      "KF": {
                        "1": { "nel": 6.2, "apde": 80, "apdn": 121, "tsv": 15 },
                        "2": { "nel": 6.1, "apde": 80, "apdn": 116, "tsv": 15 },
                        "3": { "nel": 6, "apde": 79, "apdn": 106, "tsv": 15 },
                        "4": { "nel": 5.9, "apde": 78, "apdn": 100, "tsv": 14 }
                      },
                      "KG": {
                        "1": { "nel": 6.2, "apde": 80, "apdn": 123, "tsv": 15 },
                        "2": { "nel": 5.8, "apde": 77, "apdn": 113, "tsv": 14 },
                        "3": { "nel": 5.4, "apde": 74, "apdn": 112, "tsv": 13 },
                        "4": { "nel": 5.1, "apde": 71, "apdn": 106, "tsv": 12 }
                      }
                    },
                    "hay": {
                      "G": {
                        "1": { "nel": 5.5, "apde": 110, "apdn": 94, "tsv": 15 },
                        "2": { "nel": 5.3, "apde": 100, "apdn": 91, "tsv": 15 },
                        "3": { "nel": 5, "apde": 87, "apdn": 85, "tsv": 14 },
                        "4": { "nel": 4.9, "apde": 77, "apdn": 81, "tsv": 14 }
                      },
                      "GR": {
                        "1": { "nel": 5.7, "apde": 105, "apdn": 95, "tsv": 16 },
                        "2": { "nel": 5.6, "apde": 98, "apdn": 93, "tsv": 16 },
                        "3": { "nel": 5.3, "apde": 87, "apdn": 88, "tsv": 15 },
                        "4": { "nel": 5.1, "apde": 77, "apdn": 83, "tsv": 14 }
                      },
                      "A": {
                        "1": { "nel": 5.5, "apde": 113, "apdn": 95, "tsv": 15 },
                        "2": { "nel": 5.4, "apde": 103, "apdn": 92, "tsv": 15 },
                        "3": { "nel": 5, "apde": 91, "apdn": 87, "tsv": 14 },
                        "4": { "nel": 4.8, "apde": 83, "apdn": 83, "tsv": 14 }
                      },
                      "AR": {
                        "1": { "nel": 5.7, "apde": 110, "apdn": 96, "tsv": 16 },
                        "2": { "nel": 5.6, "apde": 102, "apdn": 94, "tsv": 16 },
                        "3": { "nel": 5.4, "apde": 91, "apdn": 89, "tsv": 15 },
                        "4": { "nel": 5.1, "apde": 83, "apdn": 85, "tsv": 14 }
                      },
                      "L": {
                        "1": { "nel": 5.8, "apde": 130, "apdn": 102, "tsv": 16 },
                        "2": { "nel": 5.7, "apde": 120, "apdn": 98, "tsv": 16 },
                        "3": { "nel": 5.4, "apde": 112, "apdn": 94, "tsv": 15 },
                        "4": { "nel": 5.2, "apde": 104, "apdn": 92, "tsv": 15 }
                      },
                      "KF": {
                        "1": { "nel": 5.6, "apde": 105, "apdn": 93, "tsv": 16 },
                        "2": { "nel": 5.5, "apde": 100, "apdn": 92, "tsv": 15 },
                        "3": { "nel": 5.4, "apde": 92, "apdn": 90, "tsv": 15 },
                        "4": { "nel": 5.4, "apde": 87, "apdn": 88, "tsv": 15 }
                      },
                      "KG": {
                        "1": { "nel": 5.7, "apde": 106, "apdn": 94, "tsv": 16 },
                        "2": { "nel": 5.3, "apde": 97, "apdn": 90, "tsv": 15 },
                        "3": { "nel": 4.9, "apde": 96, "apdn": 87, "tsv": 14 },
                        "4": { "nel": 4.7, "apde": 92, "apdn": 83, "tsv": 13 }
                      }
                    }
                  }
                };

                // 4. UI-Listener initialisieren
                setupEventListeners();
                showLoading(false);

            } catch (error) {
                console.error("Initialisierungsfehler:", error);
                showLoading(false);
                document.getElementById('app-body').innerHTML = `<p class="text-red-500 text-center">Fehler: App konnte nicht initialisiert werden.</p>`;
            }
        });
        
        async function initializeFirebase() {
            try {
            // START ERSETZUNG: Ersetzen Sie den alten 'try'-Block durch diesen:

            // 1. Fügen Sie hier Ihr firebaseConfig-Objekt von Firebase ein:
            const firebaseConfig = {
              apiKey: "AIzaSyBvPcqBRCVrCBy2GIdi1vN92IC49iGb0Ks",
              authDomain: "agff-apps.firebaseapp.com",
              projectId: "agff-apps",
              storageBucket: "agff-apps.firebasestorage.app",
              messagingSenderId: "963390091539",
              appId: "1:963390091539:web:eff9117033c24eda21eae6"
            };

            // 2. Setzen Sie eine eindeutige App-ID (wichtig für den DB-Pfad)
            const appId = "agff-futter-app-public"; // Oder ein eigener Name

            // 3. Der Rest der Funktion initialisiert Firebase
            if (firebaseConfig.apiKey) {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                setLogLevel('debug'); 

                // Wir verwenden nur noch anonyme Anmeldung
                await signInAnonymously(auth);

                console.log("Firebase Auth & Firestore initialisiert. User ID:", auth.currentUser?.uid);
            } else {
                console.warn("Firebase Konfiguration nicht gefunden. Cloud-Speicherung ist deaktiviert.");
                document.getElementById('saveCloudButton').disabled = true;
                document.getElementById('saveCloudButton').title = "Cloud-Speicherung nicht konfiguriert";
            }

            // ENDE ERSETZUNG
        } catch (error) {
            console.error("Firebase Initialisierungsfehler:", error);
            document.getElementById('saveCloudButton').disabled = true;
            document.getElementById('saveCloudButton').title = "Cloud-Speicherung fehlgeschlagen";
        }
    }
        
        // --- UI FUNKTIONEN ---

        function showLoading(isLoading) {
            const spinner = document.getElementById('loading-spinner');
            if (isLoading) {
                spinner.classList.remove('hidden');
            } else {
                spinner.classList.add('hidden');
            }
        }

        function setupEventListeners() {
            // Schritt 1: Aufwuchsart
            document.getElementById('aufwuchsart').addEventListener('change', () => {
                resetSelections('step1');
                document.getElementById('step2-bestand').disabled = false;
                document.getElementById('step2-bestand').classList.remove('opacity-50', 'cursor-not-allowed');
            });

            // Schritt 2: Bestand
            document.getElementById('step2-bestand').addEventListener('change', () => {
                resetSelections('step2');
                document.getElementById('step3-stadium-button').disabled = false;
                document.getElementById('step3-stadium-button').classList.remove('opacity-50', 'cursor-not-allowed');
            });

            // Schritt 3: Stadium Modal
            document.getElementById('step3-stadium-button').addEventListener('click', openStadiumModal);
            document.getElementById('closeModalButton').addEventListener('click', closeStadiumModal);

            // Schritt 4: Berechnung
            document.querySelectorAll('#step4-buttons input[type="radio"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    document.querySelectorAll('#step4-buttons label').forEach(label => {
                        label.classList.replace('bg-green-700', 'bg-green-600');
                        label.classList.remove('ring-2', 'ring-offset-2', 'ring-green-400');
                    });
                    const selectedLabel = document.querySelector(`label[for="${e.target.id}"]`);
                    selectedLabel.classList.replace('bg-green-600', 'bg-green-700');
                    selectedLabel.classList.add('ring-2', 'ring-offset-2', 'ring-green-400');
                    
                    calculateFutterQualitaet();
                });
            });

            // Akkordeon (Parameter)
            document.getElementById('param-accordion-toggle').addEventListener('click', () => {
                const content = document.getElementById('param-accordion-content');
                const icon = document.getElementById('param-accordion-icon');
                content.classList.toggle('hidden');
                icon.classList.toggle('rotate-180');
            });

            // Parameter-Inputs (lösen Neuberechnung aus)
            document.getElementById('kuhgewicht').addEventListener('input', applyCorrections);
            document.getElementById('kuh-tsv').addEventListener('input', applyCorrections);

            // Speichern
            document.getElementById('savePdfButton').addEventListener('click', handleSavePdf);
            document.getElementById('saveCloudButton').addEventListener('click', handleSaveCloud);
        }

        // --- STADIUMS-MODAL ---

        function openStadiumModal() {
            const aufwuchs = document.getElementById('aufwuchsart').value;
            const modalContent = document.getElementById('modalContent');
            
            if (aufwuchs === 'erster') {
                modalContent.innerHTML = `
                    <h3 class="text-lg font-bold mb-4 text-gray-800">Schritt 3: Stadium bestimmen (Erster Aufwuchs)</h3>
                    <p class="mb-4 text-sm text-gray-600">Bestimmen Sie das Entwicklungsstadium gemäss den Leitpflanzen (Knaulgras, Engl. Raigras, Wiesen-Löwenzahn) oder der Zeitperiode (Tabelle S. 2).</p>
                    <div class="space-y-2">
                        <button onclick="selectStadium(1, 'Stadium 1: Bestockung / Beginn Schossen')" class="stadium-btn"><b>Stadium 1:</b> Bestockung / Beginn Schossen</button>
                        <button onclick="selectStadium(2, 'Stadium 2: Schossen (Weidestadium)')" class="stadium-btn"><b>Stadium 2:</b> Schossen (Weidestadium)</button>
                        <button onclick="selectStadium(3, 'Stadium 3: Beginn Rispenschieben (10%)')" class="stadium-btn"><b>Stadium 3:</b> Beginn Rispenschieben (10%)</button>
                        <button onclick="selectStadium(4, 'Stadium 4: Volles Rispenschieben (50%)')" class="stadium-btn"><b>Stadium 4:</b> Volles Rispenschieben (50%)</button>
                        <button onclick="selectStadium(5, 'Stadium 5: Ende Rispenschieben (90%)')" class="stadium-btn"><b>Stadium 5:</b> Ende Rispenschieben (90%)</button>
                        <button onclick="selectStadium(6, 'Stadium 6: Blüte')" class="stadium-btn"><b>Stadium 6:</b> Blüte</button>
                        <button onclick="selectStadium(7, 'Stadium 7: Samenreife')" class="stadium-btn"><b>Stadium 7:</b> Samenreife</button>
                    </div>
                `;
            } else if (aufwuchs === 'folge') {
                 modalContent.innerHTML = `
                    <h3 class="text-lg font-bold mb-4 text-gray-800">Schritt 3: Stadium bestimmen (Folgeaufwuchs)</h3>
                    <p class="mb-4 text-sm text-gray-600">Bestimmen Sie das Alter des Futters in Wochen (Tabelle S. 2). Dies ergibt das Futterstadium.</p>
                    <div class="space-y-2">
                        <button onclick="selectStadium(1, 'Stadium 1: 3-4 Wochen (Tal) / 3-4 Wochen (Berg)')" class="stadium-btn"><b>Stadium 1:</b> 3-4 Wochen (Tal) / 3-4 Wochen (Berg)</button>
                        <button onclick="selectStadium(2, 'Stadium 2: 5-7 Wochen (Tal) / 5-7 Wochen (Berg)')" class="stadium-btn"><b>Stadium 2:</b> 5-7 Wochen (Tal) / 5-7 Wochen (Berg)</button>
                        <button onclick="selectStadium(3, 'Stadium 3: 8-9 Wochen (Tal) / 8-9 Wochen (Berg)')" class="stadium-btn"><b>Stadium 3:</b> 8-9 Wochen (Tal) / 8-9 Wochen (Berg)</button>
                        <button onclick="selectStadium(4, 'Stadium 4: 10+ Wochen (Tal) / 10+ Wochen (Berg)')" class="stadium-btn"><b>Stadium 4:</b> 10+ Wochen (Tal) / 10+ Wochen (Berg)</button>
                    </div>
                `;
            }
            document.getElementById('stadiumModal').classList.remove('hidden');
        }

        // Globale Fensterfunktion, da sie von onclick im HTML aufgerufen wird
        window.selectStadium = (stadiumNr, stadiumLabel) => {
            document.getElementById('stadium').value = stadiumNr;
            aktuellesStadiumLabel = stadiumLabel; // Für Bericht speichern
            
            const button = document.getElementById('step3-stadium-button');
            button.textContent = stadiumLabel;
            button.classList.remove('bg-gray-200', 'hover:bg-gray-300');
            button.classList.add('bg-green-100', 'text-green-800', 'font-semibold', 'ring-2', 'ring-green-300');
            
            closeStadiumModal();
            resetSelections('step3');
            validateForm(); // Prüfen, ob Buttons freigeschaltet werden können
        }

        function closeStadiumModal() {
            document.getElementById('stadiumModal').classList.add('hidden');
        }

        // --- ZURÜCKSETZ-FUNKTIONEN ---

        function resetSelections(step) {
            if (step === 'step1') {
                // Setze Bestand zurück
                document.getElementById('step2-bestand').value = "";
                // Setze Stadium zurück
                const stadiumButton = document.getElementById('step3-stadium-button');
                stadiumButton.textContent = "Stadium bestimmen";
                stadiumButton.classList.remove('bg-green-100', 'text-green-800', 'font-semibold', 'ring-2', 'ring-green-300');
                stadiumButton.classList.add('bg-gray-200', 'hover:bg-gray-300');
                stadiumButton.disabled = true;
                stadiumButton.classList.add('opacity-50', 'cursor-not-allowed');
                document.getElementById('stadium').value = "";
                aktuellesStadiumLabel = "Nicht bestimmt";
            }
            if (step === 'step1' || step === 'step2') {
                // Setze Stadium zurück
                const stadiumButton = document.getElementById('step3-stadium-button');
                stadiumButton.textContent = "Stadium bestimmen";
                stadiumButton.classList.remove('bg-green-100', 'text-green-800', 'font-semibold', 'ring-2', 'ring-green-300');
                stadiumButton.classList.add('bg-gray-200', 'hover:bg-gray-300');
                document.getElementById('stadium').value = "";
                aktuellesStadiumLabel = "Nicht bestimmt";
            }
            
            // Setze Buttons, Ergebnisse und Korrekturen immer zurück
            document.querySelectorAll('#step4-buttons input[type="radio"]').forEach(radio => radio.checked = false);
            document.querySelectorAll('#step4-buttons label').forEach(label => {
                label.classList.replace('bg-green-700', 'bg-green-600');
                label.classList.remove('ring-2', 'ring-offset-2', 'ring-green-400');
                label.classList.add('opacity-50', 'cursor-not-allowed');
            });
            
            resetResults();
        }

        function resetResults() {
            document.getElementById('result').classList.add('hidden');
            document.getElementById('step5-corrections').classList.add('hidden');
            document.getElementById('param-accordion').classList.add('hidden');
            document.getElementById('save-section').classList.add('hidden');
            document.getElementById('saveFeedback').classList.add('hidden');
        }

        // --- VALIDIERUNG ---

        function validateForm() {
            const aufwuchs = document.getElementById('aufwuchsart').value;
            const bestand = document.getElementById('step2-bestand').value;
            const stadium = document.getElementById('stadium').value;

            const isValid = aufwuchs && bestand && stadium;
            
            document.querySelectorAll('#step4-buttons label').forEach(label => {
                if (isValid) {
                    label.classList.remove('opacity-50', 'cursor-not-allowed');
                } else {
                    label.classList.add('opacity-50', 'cursor-not-allowed');
                }
            });
             document.querySelectorAll('#step4-buttons input').forEach(input => {
                input.disabled = !isValid;
            });
        }
        
        // --- KORREKTUR-FAKTOREN (Seite 5) ---
        // Faktoren als Dezimalzahlen für Multiplikation (z.B. -0.01 für -1%)
        const CorrectionFactors = {
            silage: [
                { id: "ts_low", label: "Trockensubstanz (TS) < 20%", nel: -0.01, apde: -0.06, apdn: 0 },
                { id: "ts_high", label: "Trockensubstanz (TS) > 50%", nel: -0.01, apde: 0.06, apdn: 0 }, // Korrigiert auf +6% APDE
                { id: "gaer_fehlerhaft", label: "Gärqualität fehlerhaft", nel: -0.02, apde: -0.06, apdn: 0 },
                { id: "gaer_schlecht", label: "Gärqualität schlecht", nel: -0.05, apde: -0.15, apdn: -0.03 },
                { id: "nachgaerung", label: "Nachgärung (leicht warm)", nel: -0.04, apde: -0.15, apdn: -0.03 }
            ],
            hay: [
                { id: "boden", label: "Bodentrocknung", nel: -0.04, apde: -0.03, apdn: 0 },
                { id: "regen_1d", label: "1 Tag Regen", nel: -0.05, apde: -0.08, apdn: -0.02 },
                { id: "regen_2d", label: "2+ Tage Regen", nel: -0.08, apde: -0.15, apdn: -0.03 },
                { id: "ueberhitz_leicht", label: "Überhitzung/Futter leicht braun", nel: 0, apde: 0.03, apdn: 0 },
                { id: "ueberhitz_braun", label: "Überhitzung/Futter braun, brandig", nel: -0.05, apde: -0.01, apdn: -0.02 }
            ]
        };

        function generateCorrectionInputs() {
            const konserv = document.querySelector('input[name="konservierung"]:checked').value;
            const container = document.getElementById('step5-corrections-list');
            container.innerHTML = ''; // Zurücksetzen

            if (konserv === 'greenfeed') {
                document.getElementById('step5-corrections').classList.add('hidden');
                return; // Keine Korrekturen für Grünfutter
            }

            const factors = CorrectionFactors[konserv];
            if (!factors) return;

            factors.forEach(factor => {
                const nelTxt = factor.nel === 0 ? '0%' : (factor.nel > 0 ? `+${factor.nel * 100}%` : `${factor.nel * 100}%`);
                const apdeTxt = factor.apde === 0 ? '0%' : (factor.apde > 0 ? `+${factor.apde * 100}%` : `${factor.apde * 100}%`);
                const apdnTxt = factor.apdn === 0 ? '0%' : (factor.apdn > 0 ? `+${factor.apdn * 100}%` : `${factor.apdn * 100}%`);

                const div = document.createElement('div');
                div.className = "flex items-center";
                div.innerHTML = `
                    <input id="${factor.id}" name="correction" type="checkbox" value="${factor.id}" class="h-4 w-4 text-green-600 border-gray-300 rounded focus:ring-green-500 correction-check">
                    <label for="${factor.id}" class="ml-3 block text-sm text-gray-700">
                        ${factor.label} <span class="text-xs text-gray-500">(NEL: ${nelTxt}, APDE: ${apdeTxt}, APDN: ${apdnTxt})</span>
                    </label>
                `;
                container.appendChild(div);
            });

            // Event listener für die neuen Checkboxen hinzufügen
            document.querySelectorAll('.correction-check').forEach(check => {
                check.addEventListener('change', applyCorrections);
            });

            document.getElementById('step5-corrections').classList.remove('hidden');
        }
        
        // --- HAUPTBERECHNUNG ---

        function calculateFutterQualitaet() {
            const aufwuchs = document.getElementById('aufwuchsart').value;
            const bestand = document.getElementById('step2-bestand').value;
            const stadium = document.getElementById('stadium').value;
            const konserv = document.querySelector('input[name="konservierung"]:checked').value;

            if (!futterWerte[aufwuchs] || !futterWerte[aufwuchs][konserv] || !futterWerte[aufwuchs][konserv][bestand] || !futterWerte[aufwuchs][konserv][bestand][stadium]) {
                alert("Für diese Auswahl existieren keine Referenzdaten.");
                resetResults();
                return;
            }

            const basisWerte = futterWerte[aufwuchs][konserv][bestand][stadium];

            // Basiswerte im UI speichern (für Korrekturen)
            const resultsDiv = document.getElementById('result');
            resultsDiv.dataset.baseNel = basisWerte.nel;
            resultsDiv.dataset.baseApde = basisWerte.apde;
            resultsDiv.dataset.baseApdn = basisWerte.apdn;
            resultsDiv.dataset.baseTsv = basisWerte.tsv;

            // UI für Korrekturen generieren (falls nötig)
            generateCorrectionInputs();
            
            // Parameter-Akkordeon anzeigen
            document.getElementById('param-accordion').classList.remove('hidden');

            // Erste Berechnung (ohne Korrekturen) durchführen
            // Dies ruft auch displayResults auf
            applyCorrections();
        }

        // --- KORREKTUR- & PARAMETER-BERECHNUNG ---

        // Diese Funktion wird bei Klick auf Berechnen, bei Änderung der Korrekturen
        // und bei Änderung der Parameter aufgerufen.
        function applyCorrections() {
            const resultsDiv = document.getElementById('result');
            const konserv = document.querySelector('input[name="konservierung"]:checked').value;

            // 1. Basiswerte holen
            let base = {
                nel: parseFloat(resultsDiv.dataset.baseNel),
                apde: parseFloat(resultsDiv.dataset.baseApde),
                apdn: parseFloat(resultsDiv.dataset.baseApdn),
                tsv: parseFloat(resultsDiv.dataset.baseTsv)
            };

            // 2. Korrekturen anwenden (multiplikativ)
            let korrFaktoren = { nel: 1, apde: 1, apdn: 1 };
            let angewandteKorrekturen = [];
            
            if (konserv !== 'greenfeed') {
                document.querySelectorAll('.correction-check:checked').forEach(check => {
                    const factors = CorrectionFactors[konserv];
                    const factor = factors.find(f => f.id === check.value);
                    if (factor) {
                        korrFaktoren.nel *= (1 + factor.nel);
                        korrFaktoren.apde *= (1 + factor.apde);
                        korrFaktoren.apdn *= (1 + factor.apdn);
                        angewandteKorrekturen.push(factor.label);
                    }
                });
            }

            let korrWerte = {
                nel: base.nel * korrFaktoren.nel,
                apde: base.apde * korrFaktoren.apde,
                apdn: base.apdn * korrFaktoren.apdn,
                tsv: base.tsv // TSV wird (noch) nicht korrigiert
            };

            // 3. Parameter (Gewicht, TSV) holen
            let kuhGewicht = parseFloat(document.getElementById('kuhgewicht').value) || 630;
            let kuhTsv = parseFloat(document.getElementById('kuh-tsv').value) || korrWerte.tsv; // Priorisiere User-Input

            // 4. MPP Berechnen (mit korrigierten Werten und Parametern)
            const mppResult = calculateMpp(korrWerte, kuhGewicht, kuhTsv);

            // 5. Ergebnisse anzeigen
            displayResults(base, korrWerte, mppResult, angewandteKorrekturen, kuhTsv);
        }

        function calculateMpp(werte, gewicht, tsv) {
            // Erhaltungsbedarf (EB) berechnen, gemäss Formeln die 40.5 MJ NEL / 409g APD bei 630kg ergeben
            // EB NEL = (0.293 * LG^0.75) * 1.10 (Aktivitätszuschlag 10%)
            // EB APD = (3.25 * LG^0.75) * 1.10 (Aktivitätszuschlag 10%)
            const eb_nel = (0.293 * Math.pow(gewicht, 0.75)) * 1.10;
            const eb_protein = (3.25 * Math.pow(gewicht, 0.75)) * 1.10;
            
            // Verfügbare Nährstoffe für Produktion (Gesamtaufnahme - Erhaltungsbedarf)
            const verf_nel = (werte.nel * tsv) - eb_nel;
            const verf_apde = (werte.apde * tsv) - eb_protein;
            const verf_apdn = (werte.apdn * tsv) - eb_protein;

            // MPP (Milchproduktionspotenzial) pro Komponente
            const mpp_nel = verf_nel / PB_NEL;
            const mpp_apde = verf_apde / PB_PROTEIN;
            const mpp_apdn = verf_apdn / PB_PROTEIN;

            // Der tiefste Wert ist limitierend
            const mpp = Math.max(0, Math.min(mpp_nel, mpp_apde, mpp_apdn));
            
            let limit = "NEL";
            if (mpp_apde < mpp_nel && mpp_apde < mpp_apdn) limit = "APDE";
            else if (mpp_apdn < mpp_nel && mpp_apdn < mpp_apde) limit = "APDN";

            return { mpp, limit, mpp_nel, mpp_apde, mpp_apdn, eb_nel, eb_protein };
        }
        
        // --- ERGEBNIS-ANZEIGE & SPEICHER-LOGIK ---

        function displayResults(base, korr, mppResult, korrLabels, finalTsv) {
            const resultsDiv = document.getElementById('result');
            resultsDiv.classList.remove('hidden');

            const limitHighlight = (key) => mppResult.limit === key ? 'text-red-600 font-bold' : '';

            document.getElementById('res-mpp').textContent = mppResult.mpp.toFixed(1);
            document.getElementById('res-limit').textContent = mppResult.limit;
            
            // NEL
            document.getElementById('base-nel').textContent = base.nel.toFixed(2);
            document.getElementById('korr-nel').textContent = (korr.nel - base.nel).toFixed(2);
            document.getElementById('eff-nel').textContent = korr.nel.toFixed(2);
            document.getElementById('mpp-nel').textContent = mppResult.mpp_nel.toFixed(1);
            document.getElementById('mpp-nel-label').className = limitHighlight('NEL');

            // APDE
            document.getElementById('base-apde').textContent = base.apde.toFixed(0);
            document.getElementById('korr-apde').textContent = (korr.apde - base.apde).toFixed(0);
            document.getElementById('eff-apde').textContent = korr.apde.toFixed(0);
            document.getElementById('mpp-apde').textContent = mppResult.mpp_apde.toFixed(1);
            document.getElementById('mpp-apde-label').className = limitHighlight('APDE');
            
            // APDN
            document.getElementById('base-apdn').textContent = base.apdn.toFixed(0);
            document.getElementById('korr-apdn').textContent = (korr.apdn - base.apdn).toFixed(0);
            document.getElementById('eff-apdn').textContent = korr.apdn.toFixed(0);
            document.getElementById('mpp-apdn').textContent = mppResult.mpp_apdn.toFixed(1);
            document.getElementById('mpp-apdn-label').className = limitHighlight('APDN');

            // TSV populieren
            document.getElementById('base-tsv').textContent = base.tsv.toFixed(1); 
            document.getElementById('eff-tsv').textContent = finalTsv.toFixed(1); // Zeigt den Wert an, der für MPP verwendet wurde

            // Korrektur-Labels
            const korrList = document.getElementById('korrAngewandt');
            if (korrLabels.length > 0) {
                korrList.innerHTML = '<b>Angewandte Korrekturen:</b><ul class="list-disc list-inside text-sm">' + korrLabels.map(l => `<li>${l}</li>`).join('') + '</ul>';
                korrList.classList.remove('hidden');
            } else {
                korrList.classList.add('hidden');
            }
            
            // Speichern Sektion anzeigen
            document.getElementById('save-section').classList.remove('hidden');
        }
        
        // Helper für PDF/Cloud
        function getCurrentState() {
            const aufwuchs = document.getElementById('aufwuchsart');
            const bestand = document.getElementById('step2-bestand');
            const konservRadio = document.querySelector('input[name="konservierung"]:checked');
            
            const korrChecks = document.querySelectorAll('.correction-check:checked');
            const korrekturLabels = Array.from(korrChecks).map(check => {
                const label = document.querySelector(`label[for="${check.id}"]`);
                return label ? label.textContent.split(' (NEL:')[0].trim() : check.id;
            });
            
            const resultsDiv = document.getElementById('result');
            
            return {
                // Eingaben
                aufwuchsLabel: aufwuchs.options[aufwuchs.selectedIndex].text,
                bestandLabel: bestand.options[bestand.selectedIndex].text,
                stadiumLabel: aktuellesStadiumLabel,
                konservLabel: konservRadio ? document.querySelector(`label[for="${konservRadio.id}"]`).textContent.trim() : 'N/A',
                // Parameter
                kuhGewicht: document.getElementById('kuhgewicht').value,
                kuhTsv: document.getElementById('kuh-tsv').value,
                // Korrekturen
                korrekturen: korrekturLabels,
                // Ergebnisse
                basis: {
                    nel: parseFloat(resultsDiv.dataset.baseNel).toFixed(2),
                    apde: parseFloat(resultsDiv.dataset.baseApde).toFixed(0),
                    apdn: parseFloat(resultsDiv.dataset.baseApdn).toFixed(0),
                },
                effektiv: {
                    nel: document.getElementById('eff-nel').textContent,
                    apde: document.getElementById('eff-apde').textContent,
                    apdn: document.getElementById('eff-apdn').textContent,
                },
                mpp: {
                    final: document.getElementById('res-mpp').textContent,
                    limit: document.getElementById('res-limit').textContent,
                    mpp_nel: document.getElementById('mpp-nel').textContent,
                    mpp_apde: document.getElementById('mpp-apde').textContent,
                    mpp_apdn: document.getElementById('mpp-apdn').textContent,
                },
                // Meta
                person: document.getElementById('personName').value || 'Unbekannt',
                probe: document.getElementById('probeNr').value || 'N/A',
                datum: new Date().toLocaleString('de-CH')
            };
        }

        // PDF SPEICHERN
        function handleSavePdf() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const state = getCurrentState();
            
            let y = 15;
            doc.setFontSize(18);
            doc.text(`Futterbewertung AGFF: Probe ${state.probe}`, 10, y);
            y += 10;
            doc.setFontSize(10);
            doc.text(`Beurteilt von: ${state.person} am ${state.datum}`, 10, y);
            
            y += 15;
            doc.setFontSize(12);
            doc.text("EINGABEN", 10, y);
            y += 7;
            doc.setFontSize(10);
            doc.text(`- Aufwuchsart: ${state.aufwuchsLabel}`, 14, y); y += 6;
            doc.text(`- Bestandestyp: ${state.bestandLabel}`, 14, y); y += 6;
            doc.text(`- Stadium: ${state.stadiumLabel}`, 14, y); y += 6;
            doc.text(`- Konservierung: ${state.konservLabel}`, 14, y);
            
            y += 10;
            doc.setFontSize(12);
            doc.text("BERECHNUNGSPARAMETER", 10, y);
            y += 7;
            doc.setFontSize(10);
            doc.text(`- Kuhgewicht: ${state.kuhGewicht} kg`, 14, y); y += 6;

            // Logik, um den korrekten TSV zu ermitteln (da state.kuhTsv nur den Override enthält)
            const resultsDiv = document.getElementById('result');
            // Der finale TSV ist der (überschriebene) state.kuhTsv ODER (||) der Basiswert aus den Daten
            const finalTsv = state.kuhTsv || (resultsDiv.dataset.baseTsv ? parseFloat(resultsDiv.dataset.baseTsv).toFixed(2) : 'N/A');
            doc.text(`- Berücks. Futterverzehr: ${finalTsv} kg TS`, 14, y); y += 6;
            
            if (state.korrekturen.length > 0) {
                y += 10;
                doc.setFontSize(12);
                doc.text("KORREKTUREN", 10, y);
                y += 7;
                doc.setFontSize(10);
                state.korrekturen.forEach(k => {
                    doc.text(`- ${k}`, 14, y); y += 6;
                });
            }

            y += 10;
            doc.setFontSize(12);
            doc.text("ERGEBNISSE", 10, y);
            y += 7;
            doc.setFontSize(16);
            doc.setFont(undefined, 'bold');
            doc.text(`MPP: ${state.mpp.final} kg`, 14, y);
            doc.setFont(undefined, 'normal');
            doc.setFontSize(10);
            doc.text(`(Limitiert durch ${state.mpp.limit})`, 16, y + 5);
            
            y += 12;
            // Tabelle
            doc.setFontSize(10);
            doc.setFont(undefined, 'bold');
            doc.text("Nährwert", 14, y);
            doc.text("Basiswert", 60, y);
            doc.text("Effektivwert", 90, y);
            doc.text("MPP (kg)", 120, y);
            doc.setFont(undefined, 'normal');
            y += 7;
            
            const isLimitNEL = state.mpp.limit === 'NEL';
            doc.setTextColor(isLimitNEL ? 220 : 0, 0, 0);
            doc.setFont(undefined, isLimitNEL ? 'bold' : 'normal');
            doc.text("NEL (MJ/kg TS)", 14, y);
            doc.text(state.basis.nel, 60, y);
            doc.text(state.effektiv.nel, 90, y);
            doc.text(state.mpp.mpp_nel, 120, y);
            y += 7;
            
            const isLimitAPDE = state.mpp.limit === 'APDE';
            doc.setTextColor(isLimitAPDE ? 220 : 0, 0, 0);
            doc.setFont(undefined, isLimitAPDE ? 'bold' : 'normal');
            doc.text("APDE (g/kg TS)", 14, y);
            doc.text(state.basis.apde, 60, y);
            doc.text(state.effektiv.apde, 90, y);
            doc.text(state.mpp.mpp_apde, 120, y);
            y += 7;

            const isLimitAPDN = state.mpp.limit === 'APDN';
            doc.setTextColor(isLimitAPDN ? 220 : 0, 0, 0);
            doc.setFont(undefined, isLimitAPDN ? 'bold' : 'normal');
            doc.text("APDN (g/kg TS)", 14, y);
            doc.text(state.basis.apdn, 60, y);
            doc.text(state.effektiv.apdn, 90, y);
            doc.text(state.mpp.mpp_apdn, 120, y);
            
            doc.setTextColor(0, 0, 0);
            doc.setFont(undefined, 'normal');
            
            doc.save(`Futterbericht_${state.probe.replace(/[^a-z0-9]/gi, '_') || 'Bericht'}.pdf`);
        }

        // CLOUD SPEICHERN
        async function handleSaveCloud() {
            if (!db || !auth.currentUser) {
                alert("Cloud-Speicherung ist nicht initialisiert.");
                return;
            }
            
            const state = getCurrentState();
            if (!state.person || !state.probe) {
                alert("Bitte geben Sie einen Namen und eine Proben-Nummer für die Speicherung an.");
                return;
            }

            const feedbackEl = document.getElementById('saveFeedback');
            feedbackEl.classList.remove('hidden');
            feedbackEl.textContent = "Speichern...";
            feedbackEl.className = "feedback-message text-gray-700";

            try {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const userId = auth.currentUser.uid;
                
                // Speichern in einer öffentlichen Sammlung
                const collectionPath = `/artifacts/${appId}/public/data/futterproben`;
                
                const docRef = await addDoc(collection(db, collectionPath), {
                    ...state,
                    userId: userId, // ID des Erstellers
                    createdAt: serverTimestamp() // Zeitstempel
                });

                console.log("Dokument gespeichert mit ID: ", docRef.id);
                feedbackEl.textContent = `Probe ${state.probe} erfolgreich in der Cloud gespeichert!`;
                feedbackEl.className = "feedback-message text-blue-600";
                
            } catch (error) {
                console.error("Fehler beim Speichern in Firestore: ", error);
                feedbackEl.textContent = "Fehler beim Speichern. (Details in Konsole)";
                feedbackEl.className = "feedback-message text-red-600";
            }
        }

    </script>
    <style>
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Noto Sans', sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
            background-color: #f8f9fa;
        }
        .step-card {
            background-color: white;
            border-radius: 0.75rem; /* 12px */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transition: all 0.2s ease-in-out;
        }
        .step-label {
            display: block;
            margin-bottom: 0.5rem;
            font-size: 0.875rem; /* 14px */
            font-weight: 600;
            color: #374151; /* gray-700 */
        }
        .select-input {
            width: 100%;
            border-radius: 0.5rem; /* 8px */
            border: 1px solid #D1D5DB; /* gray-300 */
            padding: 0.75rem 1rem; /* 12px 16px */
            font-size: 1rem; /* 16px */
            background-color: #F9FAFB; /* gray-50 */
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .select-input:focus {
            outline: none;
            border-color: #2563EB; /* blue-600 */
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.25);
        }
        .select-input:disabled {
            background-color: #E5E7EB; /* gray-200 */
            cursor: not-allowed;
            opacity: 0.7;
        }
        .calc-button {
            display: inline-block;
            width: 100%;
            padding: 1rem;
            font-size: 1rem; /* 16px */
            font-weight: 600;
            text-align: center;
            color: white;
            border-radius: 0.5rem; /* 8px */
            transition: all 0.2s;
            cursor: pointer;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        }
        .calc-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .calc-button.opacity-50 {
            cursor: not-allowed;
            background-color: #9CA3AF; /* gray-400 */
        }
        .calc-button.opacity-50:hover {
            transform: none;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        }
        
        /* Visuelles Verstecken für Radio-Buttons */
        .radio-hidden {
            position: absolute;
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .result-box {
            background: linear-gradient(145deg, #ffffff, #e6eef4);
            border: 1px solid #d1d5db;
        }
        
        .limit-label {
            background-color: #FEE2E2; /* red-100 */
            color: #991B1B; /* red-800 */
            padding: 0.25rem 0.5rem;
            border-radius: 9999px;
            font-size: 0.75rem; /* 12px */
            font-weight: 600;
        }
        
        .stadium-btn {
            display: block;
            width: 100%;
            text-align: left;
            padding: 0.75rem 1rem;
            background-color: #f3f4f6; /* gray-100 */
            color: #1f2937; /* gray-800 */
            border-radius: 0.5rem;
            transition: all 0.2s;
        }
        .stadium-btn:hover {
            background-color: #e5e7eb; /* gray-200 */
            transform: translateX(2px);
        }
        .stadium-btn b {
            color: #15803d; /* green-700 */
        }
        
        .feedback-message {
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            margin-top: 0.5rem;
        }
        .feedback-message.text-red-600 { background-color: #fef2f2; color: #dc2626; }
        .feedback-message.text-blue-600 { background-color: #dbeafe; color: #1e40af; }
    </style>
</head>
<body class="antialiased text-gray-900">

    <!-- Lade-Spinner -->
    <div id="loading-spinner" class="hidden fixed inset-0 bg-white bg-opacity-75 flex items-center justify-center z-50">
        <svg class="animate-spin h-12 w-12 text-green-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
    </div>

    <!-- Hauptcontainer -->
    <div id="app-body" class="max-w-xl mx-auto p-4 md:p-6 lg:p-8">
        
        <!-- Header -->
        <header class="text-center mb-6">
            <h1 class="text-3xl font-bold text-green-800">Futterbewertung</h1>
            <p class="text-lg text-gray-600">nach AGFF Merkblatt 3</p>
        </header>

        <!-- Schritt 1: Aufwuchsart -->
        <div class="step-card p-5 mb-4">
            <label for="aufwuchsart" class="step-label">Schritt 1: Aufwuchsart</label>
            <select id="aufwuchsart" class="select-input">
                <option value="" disabled selected>Bitte wählen...</option>
                <option value="erster">Erster Aufwuchs (Frühling)</option>
                <option value="folge">Folgeaufwuchs (Sommer/Herbst)</option>
            </select>
        </div>

        <!-- Schritt 2: Bestandestyp -->
        <div class="step-card p-5 mb-4">
            <label for="step2-bestand" class="step-label">Schritt 2: Bestandestyp</label>
            <select id="step2-bestand" class="select-input opacity-50 cursor-not-allowed" disabled>
                <option value="" disabled selected>Bitte wählen...</option>
                <option value="G">G: Gräserreich (andere Gräser)</option>
                <option value="GR">GR: Gräserreich (Raigräser)</option>
                <option value="A">A: Ausgewogen (andere Gräser)</option>
                <option value="AR">AR: Ausgewogen (Raigräser)</option>
                <option value="L">L: Leguminosenreich</option>
                <option value="KF">KF: Kräuterreich (fein)</option>
                <option value="KG">KG: Kräuterreich (grob)</option>
            </select>
        </div>

        <!-- Schritt 3: Stadium -->
        <div class="step-card p-5 mb-4">
            <label for="step3-stadium-button" class="step-label">Schritt 3: Entwicklungsstadium</label>
            <input type="hidden" id="stadium">
            <button id="step3-stadium-button" class="w-full text-left px-4 py-3 bg-gray-200 text-gray-700 rounded-lg font-medium hover:bg-gray-300 transition opacity-50 cursor-not-allowed" disabled>
                Stadium bestimmen
            </button>
        </div>

        <!-- Schritt 4: Berechnung (Konservierung) -->
        <div class="step-card p-5 mb-4">
            <label class="step-label">Schritt 4: Konservierungsart & Berechnung</label>
            <div id="step4-buttons" class="grid grid-cols-1 sm:grid-cols-3 gap-3">
                <!-- Grünfutter -->
                <div>
                    <input type="radio" name="konservierung" id="konserv-greenfeed" value="greenfeed" class="radio-hidden" disabled>
                    <label for="konserv-greenfeed" class="calc-button bg-green-600 hover:bg-green-700 opacity-50 cursor-not-allowed">
                        Grünfutter
                    </label>
                </div>
                <!-- Silage -->
                <div>
                    <input type="radio" name="konservierung" id="konserv-silage" value="silage" class="radio-hidden" disabled>
                    <label for="konserv-silage" class="calc-button bg-green-600 hover:bg-green-700 opacity-50 cursor-not-allowed">
                        Silage
                    </label>
                </div>
                <!-- Dürrfutter -->
                <div>
                    <input type="radio" name="konservierung" id="konserv-hay" value="hay" class="radio-hidden" disabled>
                    <label for="konserv-hay" class="calc-button bg-green-600 hover:bg-green-700 opacity-50 cursor-not-allowed">
                        Dürrfutter
                    </label>
                </div>
            </div>
        </div>
        
        <!-- Schritt 5: Korrekturen -->
        <div id="step5-corrections" class="step-card p-5 mb-4 hidden">
             <label class="step-label">Schritt 5: Konservierungs-Korrekturen (optional)</label>
             <p class="text-sm text-gray-500 mb-3">Wählen Sie zutreffende Mängel (gem. Merkblatt S. 5).</p>
             <div id="step5-corrections-list" class="space-y-3">
                 <!-- Checkboxen werden dynamisch generiert -->
             </div>
        </div>

        <!-- Resultate -->
        <div id="result" class="step-card result-box p-5 mb-4 hidden">
            <h3 class="text-xl font-bold text-gray-800 mb-4">Ergebnis der Schätzung</h3>
            
            <div class="text-center mb-4 p-4 bg-white rounded-lg shadow-inner">
                <label class="block text-sm font-medium text-gray-500">Milchproduktionspotenzial (MPP)</label>
                <div class="text-5xl font-extrabold text-green-700 my-1">
                    <span id="res-mpp">0.0</span> <span class="text-3xl">kg</span>
                </div>
                <div class="text-sm text-gray-600">
                    Limitiert durch: <span id="res-limit" class="limit-label">NEL</span>
                </div>
            </div>

            <div class="space-y-3">
                <!-- Tabelle -->
                <div class="grid grid-cols-4 gap-2 text-sm">
                    <div class="font-bold text-gray-600">Nährwert</div>
                    <div class="font-bold text-gray-600 text-right">Basiswert</div>
                    <div class="font-bold text-gray-600 text-right">Korrektur</div>
                    <div class="font-bold text-gray-600 text-right">Effektiv</div>
                    
                    <!-- NEL Zeile -->
                    <div id="mpp-nel-label" class="">NEL (MJ)</div>
                    <div id="base-nel" class="text-right">0.00</div>
                    <div id="korr-nel" class="text-right">0.00</div>
                    <div id="eff-nel" class="text-right font-medium">0.00</div>
                    
                    <!-- APDE Zeile -->
                    <div id="mpp-apde-label" class="">APDE (g)</div>
                    <div id="base-apde" class="text-right">0</div>
                    <div id="korr-apde" class="text-right">0</div>
                    <div id="eff-apde" class="text-right font-medium">0</div>
                    
                    <!-- APDN Zeile -->
                    <div id="mpp-apdn-label" class="">APDN (g)</div>
                    <div id="base-apdn" class="text-right">0</div>
                    <div id="korr-apdn" class="text-right">0</div>
                    <div id="eff-apdn" class="text-right font-medium">0</div>
                    
                    <!-- TSV Zeile -->
                    <div class="font-bold border-t pt-2">TSV (kg TS)</div>
                    <div id="base-tsv" class="text-right border-t pt-2">0.0</div>
                    <div class="text-right border-t pt-2 text-gray-400">--</div> <!-- Keine Korrektur für TSV -->
                    <div id="eff-tsv" class="text-right font-medium border-t pt-2">0.0</div>
                </div>

                <div class="border-t border-gray-200 pt-3 text-sm">
                    <div class="font-bold text-gray-600">MPP pro Nährstoff</div>
                    <div class="grid grid-cols-3 gap-2 text-center mt-1">
                        <div>
                            <span id="mpp-nel" class="font-medium">0.0</span>
                            <span class="block text-xs text-gray-500">kg (NEL)</span>
                        </div>
                        <div>
                            <span id="mpp-apde" class="font-medium">0.0</span>
                            <span class="block text-xs text-gray-500">kg (APDE)</span>
                        </div>
                         <div>
                            <span id="mpp-apdn" class="font-medium">0.0</span>
                            <span class="block text-xs text-gray-500">kg (APDN)</span>
                        </div>
                    </div>
                </div>
                
                <div id="korrAngewandt" class="hidden text-gray-600 border-t border-gray-200 pt-3 mt-3">
                    <!-- Angewandte Korrekturen -->
                </div>
            </div>
        </div>

        <!-- Parameter Akkordeon -->
        <div id="param-accordion" class="step-card mb-4 hidden">
            <button id="param-accordion-toggle" class="flex justify-between items-center w-full p-4 text-left font-medium text-gray-700">
                <span>Optionale Parameter anpassen</span>
                <svg id="param-accordion-icon" class="w-5 h-5 transform transition-transform" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                </svg>
            </button>
            <div id="param-accordion-content" class="hidden p-5 border-t border-gray-200">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label for="kuhgewicht" class="step-label">Kuhgewicht (kg)</label>
                        <input type="number" id="kuhgewicht" value="630" class="select-input">
                    </div>
                    <div>
                        <label for="kuh-tsv" class="step-label">TS-Verzehr (kg TS)</label>
                        <input type="number" id="kuh-tsv" placeholder="Automatisch (Basis)" class="select-input">
                    </div>
                </div>
                <p class="text-xs text-gray-500 mt-3">Hinweis: Der Erhaltungsbedarf wird basierend auf dem Kuhgewicht berechnet. Der TS-Verzehr wird vom Basiswert übernommen, kann hier aber überschrieben werden.</p>
            </div>
        </div>
        
        <!-- Speichern Sektion -->
        <div id="save-section" class="step-card p-5 mb-4 hidden">
            <h3 class="step-label">Beurteilung speichern</h3>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                 <div>
                    <label for="personName" class="block text-sm font-medium text-gray-700">Ihr Name</label>
                    <input type="text" id="personName" class="select-input mt-1" placeholder="Max Mustermann">
                </div>
                <div>
                    <label for="probeNr" class="block text-sm font-medium text-gray-700">Probe-Nr. / Schlag</label>
                    <input type="text" id="probeNr" class="select-input mt-1" placeholder="Wiese 1 / 2024-05-10">
                </div>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                <button id="savePdfButton" class="calc-button bg-blue-600 hover:bg-blue-700">
                    PDF-Bericht speichern
                </button>
                <button id="saveCloudButton" class="calc-button bg-gray-700 hover:bg-gray-800">
                    In Cloud speichern
                </button>
            </div>
            <div id="saveFeedback" class="feedback-message hidden mt-3"></div>
        </div>

    </div> <!-- Ende app-body -->
    
    <!-- Modal-Hintergrund -->
    <div id="stadiumModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-30">
        <!-- Modal-Container -->
        <div class="relative top-20 mx-auto p-5 border w-full max-w-lg shadow-lg rounded-xl bg-white">
            <div class="flex justify-between items-center mb-3">
                <h3 class="text-xl font-bold text-gray-900">Stadium wählen</h3>
                <button id="closeModalButton" class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm p-1.5 ml-auto inline-flex items-center">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
                </button>
            </div>
            <div id="modalContent" class="p-5">
                <!-- Inhalt wird dynamisch geladen -->
            </div>
        </div>
    </div>

</body>
</html>



